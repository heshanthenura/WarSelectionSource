chestPrice = 1000000
chestCouponWidgets = {
  [1] = 390,
  [2] = 394,
  [3] = 393,
  [4] = 392,
  [5] = 470,
  [6] = 471,
  [7] = 472,
  [8] = 473,
  [9] = 474,
  [10] = 476,
  [11] = 477,
  [12] = 478,
  [13] = 479,
  [14] = 483,
  [16] = 469,
  [17] = 444,
  [19] = 389,
  [20] = 482,
  [21] = 481,
  [22] = 386,
  [23] = 329,
  [24] = 539,
  [26] = 456,
  [25] = 157,
  [27] = 725,
  [28] = 729,
  [29] = 738,
  [30] = 833
}
decorImageWidgets = {
  [5] = 543,
  [6] = 587,
  [8] = 551,
  [9] = 560,
  [22] = 563,
  [23] = 566,
  [24] = 570,
  [25] = 571,
  [26] = 586,
  [27] = 574,
  [28] = 578,
  [29] = 554,
  [30] = 50,
  [32] = 722,
  [33] = 592,
  [34] = 734
}
productNames = {
  localize("<*storeLotModesName>"),
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  "",
  localize("<*storeLotCountryBrName>"),
  localize("<*storeLotCountryInName>"),
  localize("<*storeLotCountryTrName>"),
  localize("<*storeLotCountryGeName>"),
  localize("<*storeLotCountryRuName>"),
  localize("<*storeLotCountryFrName>"),
  localize("<*storeLotCountryCnName>"),
  localize("<*storeLotCountryJpName>"),
  localize("<*storeLotCountryPlName>"),
  localize("<*storeLotCountryHuName>"),
  localize("<*storeLotAllPackName>"),
  "",
  "",
  "",
  "",
  localize("<*storeLotFireworksName>"),
  localize("<*storeLotHeadlessHorsemanName>"),
  localize("<*storeLotSnowfallName>"),
  localize("<*storeLotRabbitName>"),
  localize("<*storeLotCursedGroundName>"),
  localize("<*storeLotCountryIrName>"),
  localize("<*storeLotDragonName>"),
  localize("<*storeLotMeteorPumpkinName>"),
  localize("<*storeLotSylvanSerpentName>"),
  localize("<*storeLotCountryItName>")
}
local propertyNames = {
  localize("<*propertyModesName>"),
  localize("<*propertyDanceWorkersName>"),
  localize("<*propertyHappyBombName>"),
  localize("<*propertyXtreeName>"),
  localize("<*propertyDanceSpearmenName>"),
  localize("<*propertyCountryBrName>"),
  localize("<*propertyCountryInName>"),
  localize("<*propertyCountryTrName>"),
  localize("<*propertyCountryGeName>"),
  localize("<*propertyCountryRuName>"),
  localize("<*propertyCountryFrName>"),
  localize("<*propertyCountryCnName>"),
  localize("<*propertyCountryJpName>"),
  localize("<*propertyCountryPlName>"),
  localize("<*propertyCountryHuName>"),
  "",
  localize("<*propertyPumpkinName>"),
  localize("<*propertyBullName>"),
  "",
  localize("<*propertyCookieName>"),
  localize("<*propertyTigerName>"),
  localize("<*propertyFireworksName>"),
  localize("<*propertyHeadlessHorsemanName>"),
  localize("<*propertySnowfallName>"),
  localize("<*propertyRabbitName>"),
  localize("<*propertyCursedGroundName>"),
  localize("<*propertyCountryIrName>"),
  localize("<*propertyDragonName>"),
  localize("<*propertyMeteorPumpkinName>"),
  localize("<*propertySylvanSerpentName>"),
  localize("<*propertyCountryItName>")
}
fonts = {
  ru = localize("<*font_ru>"),
  br = localize("<*font_br>"),
  cn = localize("<*font_cn>"),
  cs = localize("<*font_cs>"),
  sk = localize("<*font_sk>"),
  da = localize("<*font_da>"),
  de = localize("<*font_de>"),
  en = localize("<*font_en>"),
  es = localize("<*font_es>"),
  fr = localize("<*font_fr>"),
  hi = localize("<*font_hi>"),
  it = localize("<*font_it>"),
  ka = localize("<*font_ka>"),
  kr = localize("<*font_kr>"),
  pl = localize("<*font_pl>"),
  tr = localize("<*font_tr>"),
  nl = localize("<*font_nl>"),
  sr = localize("<*font_sr>"),
  hu = localize("<*font_hu>"),
  tw = localize("<*font_tw>"),
  hr = localize("<*font_hr>"),
  ja = localize("<*font_ja>"),
  th = localize("<*font_th>"),
  fa = localize("<*font_fa>"),
  unk = localize("<*font_unk>")
}
strTimeH0 = localize("<*timerHour/0>")
strTimeH1 = localize("<*timerHour/1>")
strTimeH2 = localize("<*timerHour/2>")
strTimeD0 = localize("<*timerDay/0>")
strTimeD1 = localize("<*timerDay/1>")
strTimeD2 = localize("<*timerDay/2>")
strTimeD3 = localize("<*timerDay/3>")
strTimeL0 = localize("<*timerLong/0>")
strTimeL1 = localize("<*timerLong/1>")
strTimeL2 = localize("<*timerLong/2>")
products = {
  {
    property = 25,
    product = 30,
    widgetsButton = {
      button = 48,
      priceByMoney = 51,
      buyByMoney = 52,
      alreadyBought = 53,
      couponBuy = 49
    }
  },
  {
    property = 15,
    product = 21,
    widgetsButton = {
      button = 33,
      wrongRegion = 34,
      buyPanel = 159,
      priceByMoney = 36,
      priceByMoneyOld = {621, 619},
      alreadyBought = 37
    },
    widgetsWindow = {
      window = 161,
      music = 3,
      wrongRegion = 162,
      buyPanel = 164,
      buyByMoney = 164,
      priceByMoney = 165,
      alreadyBought = 166,
      couponBuy = 167
    }
  },
  {
    property = 0,
    product = 0,
    widgetsButton = {
      button = 38,
      wrongRegion = 39,
      buyPanel = 719,
      priceByMoney = 40,
      priceByMoneyOld = {684, 685},
      alreadyBought = 41
    },
    widgetsWindow = {
      window = 174,
      confirmation = 547,
      music = 3,
      wrongRegion = 175,
      buyPanel = 181,
      buyByMoney = 181,
      priceByMoney = 178,
      alreadyBought = 180,
      couponBuy = 179
    }
  },
  {
    property = 5,
    product = 11,
    priceTp = 10000,
    widgetsButton = {
      button = 54,
      wrongRegion = 55,
      buyPanel = 56,
      priceByTp = 58,
      priceByMoney = 57,
      priceByMoneyOld = {691, 693},
      alreadyBought = 59
    },
    widgetsWindow = {
      window = 190,
      music = 4,
      wrongRegion = 191,
      buyPanel = 193,
      buyByTp = 194,
      priceByTp = 195,
      buyByMoney = 196,
      priceByMoney = 197,
      alreadyBought = 198,
      couponBuy = 199
    }
  },
  {
    property = 6,
    product = 12,
    priceTp = 10000,
    widgetsButton = {
      button = 60,
      wrongRegion = 61,
      buyPanel = 62,
      priceByTp = 71,
      priceByMoney = 70,
      priceByMoneyOld = {679, 681},
      alreadyBought = 65
    },
    widgetsWindow = {
      window = 214,
      music = 5,
      wrongRegion = 216,
      buyPanel = 217,
      buyByTp = 218,
      priceByTp = 220,
      buyByMoney = 221,
      priceByMoney = 222,
      alreadyBought = 223,
      couponBuy = 225
    }
  },
  {
    property = 7,
    product = 13,
    priceTp = 10000,
    widgetsButton = {
      button = 66,
      wrongRegion = 67,
      buyPanel = 68,
      priceByTp = 74,
      priceByMoney = 73,
      priceByMoneyOld = {683, 682},
      alreadyBought = 75
    },
    widgetsWindow = {
      window = 239,
      music = 6,
      wrongRegion = 241,
      buyPanel = 243,
      buyByTp = 244,
      priceByTp = 245,
      buyByMoney = 246,
      priceByMoney = 247,
      alreadyBought = 248,
      couponBuy = 249
    }
  },
  {
    property = 8,
    product = 14,
    priceTp = 10000,
    widgetsButton = {
      button = 76,
      wrongRegion = 77,
      buyPanel = 78,
      priceByTp = 80,
      priceByMoney = 79,
      priceByMoneyOld = {695, 694},
      alreadyBought = 81
    },
    widgetsWindow = {
      window = 10,
      music = 7,
      wrongRegion = 32,
      buyPanel = 264,
      buyByTp = 142,
      priceByTp = 146,
      buyByMoney = 265,
      priceByMoney = 266,
      alreadyBought = 267,
      couponBuy = 269
    }
  },
  {
    property = 9,
    product = 15,
    priceTp = 10000,
    widgetsButton = {
      button = 82,
      wrongRegion = 83,
      buyPanel = 84,
      priceByTp = 86,
      priceByMoney = 85,
      priceByMoneyOld = {697, 698},
      alreadyBought = 87
    },
    widgetsWindow = {
      window = 287,
      music = 8,
      wrongRegion = 290,
      buyPanel = 289,
      buyByTp = 291,
      priceByTp = 292,
      buyByMoney = 293,
      priceByMoney = 294,
      alreadyBought = 295,
      couponBuy = 296
    }
  },
  {
    property = 10,
    product = 16,
    priceTp = 10000,
    widgetsButton = {
      button = 88,
      wrongRegion = 89,
      buyPanel = 90,
      priceByTp = 92,
      priceByMoney = 91,
      priceByMoneyOld = {699, 702},
      alreadyBought = 94
    },
    widgetsWindow = {
      window = 313,
      music = 9,
      wrongRegion = 314,
      buyPanel = 316,
      buyByTp = 317,
      priceByTp = 318,
      buyByMoney = 319,
      priceByMoney = 321,
      alreadyBought = 322,
      couponBuy = 323
    }
  },
  {
    property = 11,
    product = 17,
    priceTp = 10000,
    widgetsButton = {
      button = 93,
      wrongRegion = 96,
      buyPanel = 97,
      priceByTp = 99,
      priceByMoney = 98,
      priceByMoneyOld = {706, 705},
      alreadyBought = 100
    },
    widgetsWindow = {
      window = 337,
      music = 10,
      wrongRegion = 355,
      buyPanel = 356,
      buyByTp = 357,
      priceByTp = 358,
      buyByMoney = 359,
      priceByMoney = 360,
      alreadyBought = 361,
      couponBuy = 362
    }
  },
  {
    property = 12,
    product = 18,
    priceTp = 10000,
    widgetsButton = {
      button = 101,
      wrongRegion = 102,
      buyPanel = 104,
      priceByTp = 106,
      priceByMoney = 105,
      priceByMoneyOld = {707, 708},
      alreadyBought = 107
    },
    widgetsWindow = {
      window = 377,
      music = 11,
      wrongRegion = 397,
      buyPanel = 398,
      buyByTp = 399,
      priceByTp = 400,
      buyByMoney = 401,
      priceByMoney = 402,
      alreadyBought = 403,
      couponBuy = 404
    }
  },
  {
    property = 13,
    product = 19,
    priceTp = 10000,
    widgetsButton = {
      button = 108,
      wrongRegion = 109,
      buyPanel = 110,
      priceByTp = 112,
      priceByMoney = 111,
      priceByMoneyOld = {710, 712},
      alreadyBought = 113
    },
    widgetsWindow = {
      window = 418,
      music = 12,
      wrongRegion = 419,
      buyPanel = 421,
      buyByTp = 422,
      priceByTp = 423,
      buyByMoney = 424,
      priceByMoney = 425,
      alreadyBought = 426,
      couponBuy = 427
    }
  },
  {
    property = 14,
    product = 20,
    priceTp = 10000,
    widgetsButton = {
      button = 114,
      wrongRegion = 115,
      buyPanel = 116,
      priceByTp = 118,
      priceByMoney = 117,
      priceByMoneyOld = {713, 715},
      alreadyBought = 119
    },
    widgetsWindow = {
      window = 443,
      music = 13,
      wrongRegion = 459,
      buyPanel = 461,
      buyByTp = 462,
      priceByTp = 463,
      buyByMoney = 464,
      priceByMoney = 465,
      alreadyBought = 466,
      couponBuy = 467
    }
  },
  {
    property = 26,
    product = 31,
    priceTp = 10000,
    widgetsButton = {
      button = 615,
      wrongRegion = 624,
      buyPanel = 625,
      priceByTp = 651,
      priceByMoney = 635,
      priceByMoneyOld = {716, 717},
      alreadyBought = 640
    },
    widgetsWindow = {
      window = 652,
      music = 14,
      wrongRegion = 655,
      buyPanel = 660,
      buyByTp = 674,
      priceByTp = 675,
      buyByMoney = 665,
      priceByMoney = 666,
      alreadyBought = 663,
      couponBuy = 661
    }
  },
  {
    property = 30,
    product = 35,
    priceTp = 10000,
    highPrice = {
      price = 20000,
      timer1 = {793, 784},
      timer2 = {782, 778},
      priceWidget1 = 815,
      priceWidget2 = 761,
      buyWidget1 = 757,
      buyWidget2 = 814
    },
    widgetsButton = {
      button = 737,
      wrongRegion = 741,
      buyPanel = 748,
      priceByTp = 783,
      priceByMoney = 756,
      priceByMoneyOld = {754, 753},
      alreadyBought = 750
    },
    widgetsWindow = {
      window = 767,
      music = 15,
      wrongRegion = 768,
      buyPanel = 770,
      buyByTp = 751,
      priceByTp = 777,
      buyByMoney = 811,
      priceByMoney = 812,
      alreadyBought = 808,
      couponBuy = 809
    }
  }
}

function formatNumberWithSpaces(n)
  local str = tostring(n)
  local result = ""
  local count = 0
  for i = #str, 1, -1 do
    count = count + 1
    result = str:sub(i, i) .. result
    if count % 3 == 0 and i ~= 1 then
      result = " " .. result
    end
  end
  return result
end

function isValidRegion(propValue)
  return propValue + 0.001 >= regionCoef
end

function getPropValue(prop)
  local v = propValues[prop]
  if v == nil then
    return 0
  end
  return v
end

function isValidPropRegion(prop)
  local v = getPropValue(prop)
  if v == 0 then
    return true
  end
  return isValidRegion(v)
end

function isPropertyAvailable(id)
  local p = propValues[id]
  if p == nil or p == 0 then
    return 0
  end
  if not isValidRegion(p) then
    return 1
  end
  return 2
end

function closeChestWindow()
  local nodes = interface.nodes
  nodes[349].visible = false
  root.storage_set = {
    "lastChestTime",
    showChestTime
  }
end

function tryShowChest(json)
  if json == nil then
    return
  end
  showChestTime = json.time
  local storage = root.storage
  local storedTime = tonumber(storage.lastChestTime)
  if showChestTime == storedTime then
    return
  end
  local nodes = interface.nodes
  nodes[349].visible = true
  nodes[342].disabled = false
  nodes[338].visible = false
  for i, value in pairs(chestCouponWidgets) do
    nodes[value].visible = false
  end
  if json.property ~= nil then
    assert(json.property ~= 0)
    assert(json.property ~= nil)
    nodes[chestCouponWidgets[json.property]].visible = true
    nodes[351].visible = isPropertyAvailable(json.property) ~= 2
    nodes[351].disabled = false
    chestCoupon = json.coupon
    assert(chestCoupon ~= nil)
  else
    nodes[351].visible = false
  end
  if json.techPoints ~= nil then
    nodes[382].visible = true
    nodes[519].widget_text = json.techPoints
  else
    nodes[382].visible = false
  end
end

function updateChestChecker()
  local nodes = interface.nodes
  nodes[342].disabled = not nodes[341].widget_checked or not (techPoints >= chestPrice)
end

function getRegionPriceStr(price, coef)
  return string.format("%.2f ", math.ceil(price * coef) / 100) .. currencyName
end

function getPriceStr(product, property, koef)
  if priceList == nil then
    return nil
  end
  local boughtCoef = getPropValue(property)
  if isValidRegion(boughtCoef) then
    return "0.00 " .. currencyName
  end
  local price = priceList[product + 1]
  assert(price ~= nil)
  local k = (regionCoef - boughtCoef) / regionCoef
  if koef ~= nil then
    k = k * koef
  end
  return getRegionPriceStr(price, k)
end

function closeAllWindows()
  local nodes = interface.nodes
  for _, co in ipairs(products) do
    if co.widgetsWindow ~= nil then
      nodes[co.widgetsWindow.window].visible = false
    end
  end
  nodes[17].visible = false
  nodes[120].visible = false
  nodes[2].visible = false
  nodes[338].visible = false
  startMusic()
end

function getProductNameRegional(product)
  local name = productNames[product + 1]
  if 1 > regionCoef then
    name = name .. localize("<*storeRegionalDiscount/0>" .. math.floor((1 - regionCoef) * 100) .. "<*storeRegionalDiscount/1>")
  end
  return name
end

function showError(text)
  local nodes = interface.nodes
  nodes[383].visible = true
  nodes[524].widget_text = text
end

function productBuy(product)
  closeAllWindows()
  local json = {
    product = product,
    currency = root.launcher.currency.signed,
    description = getProductNameRegional(product),
    language = root.language
  }
  log("Product buy")
  log(json)
  if root.lobby.f_sendCommand(3, toJson(json)) then
    local nodes = interface.nodes
    nodes[1].disabled = true
    showError(localize("<*storeStartSteamTransaction>"))
  else
    showError(localize("<*menuErrorNoLobby>"))
  end
end

function hexToInt(hex)
  if 48 <= hex and hex <= 57 then
    return hex - 48
  end
  if 97 <= hex and hex <= 102 then
    return hex - 87
  end
  if 65 <= hex and hex <= 70 then
    return hex - 55
  end
  return 0
end

function isBitSet(id, set)
  local letterId = id // 4 + 1
  if letterId > #set then
    return false
  end
  local ch = set:byte(letterId)
  local v = hexToInt(ch)
  local shift = id % 4
  return v & 1 << shift > 0
end

function getCurrentServerTime()
  return connectServerTime + (os.time() - connectLocalTime)
end

function toTimeStr(value)
  if value < 3600 then
    local min = value // 60
    local sec = value % 60
    return string.format(strTimeH0 .. "%u" .. strTimeH1 .. "%02d" .. strTimeH2, min, sec)
  end
  if value < 86400 then
    local hour = value // 3600
    local min = value % 3600 // 60
    local sec = value % 60
    return string.format(strTimeD0 .. "%u" .. strTimeD1 .. "%02d" .. strTimeD2 .. "%02d" .. strTimeD3, hour, min, sec)
  end
  local day = value // 86400
  local hour = value % 86400 // 3600
  return string.format(strTimeL0 .. "%u" .. strTimeL1 .. "%02d" .. strTimeL2, day, hour)
end

function getFontName(text)
  assert(text ~= "")
  local font = fonts[root.functions.f_detectLanguage(text)]
  assert(font ~= nil)
  return font
end

function setWidgetText(widgetText, text)
  assert(text ~= "")
  widgetText.text = text
  widgetText.fontName = getFontName(text)
end

function showCoupon(code, expire, properties, receiver, action, couponRegion)
  assert(propValues ~= nil)
  couponTime = expire
  local nodes = interface.nodes
  nodes[120].visible = true
  nodes[122].widget_text = code
  nodes[124].visible = false
  nodes[126].visible = false
  nodes[127].visible = false
  nodes[128].visible = false
  nodes[129].visible = false
  nodes[130].visible = false
  nodes[131].visible = false
  local hasAllProps = true
  local props = ""
  local minPropValue = 1.0
  for p = 0, 50 do
    if isBitSet(p, properties) then
      if 0 < #props then
        props = props .. ", "
      end
      props = props .. propertyNames[p + 1]
      hasAllProps = hasAllProps and isPropertyAvailable(p) == 2
      local pr = getPropValue(p)
      if minPropValue > pr then
        minPropValue = pr
      end
    end
  end
  nodes[123].widget_text = props
  if receiver ~= nil then
    nodes[131].visible = true
    setWidgetText(nodes[133].widget, receiver)
  else
    local haveTime = couponTime - getCurrentServerTime()
    if haveTime <= 0 then
      nodes[129].visible = true
    else
      nodes[124].visible = haveTime < 315360000
      nodes[125].widget_text = toTimeStr(haveTime)
      if hasAllProps then
        nodes[130].visible = true
      elseif isBitSet(action, couponActions) then
        nodes[128].visible = true
      else
        if not isValidRegion(minPropValue + couponRegion) then
          nodes[127].visible = true
        end
        nodes[126].visible = true
      end
    end
  end
end

function updateProducts()
  local nodes = interface.nodes
  for _, co in ipairs(products) do
    local b = co.widgetsButton
    local w = co.widgetsWindow
    local validRegion = isValidPropRegion(co.property)
    local av = isPropertyAvailable(co.property) == 2
    if b.wrongRegion ~= nil then
      nodes[b.wrongRegion].visible = not validRegion
    end
    nodes[b.alreadyBought].visible = av
    if b.buyPanel ~= nil then
      nodes[b.buyPanel].visible = not av
    end
    if w ~= nil then
      local price = getPriceStr(co.product, co.property)
      local hasPrice = price ~= nil
      nodes[nodes[w.priceByMoney].parent].visible = hasPrice
      nodes[w.couponBuy].visible = hasPrice
      nodes[w.wrongRegion].visible = not validRegion
      nodes[w.alreadyBought].visible = av
      if b.buyPanel ~= nil then
        nodes[w.buyPanel].visible = not av
      end
      if w.buyByTp ~= nil then
        nodes[w.buyByTp].disabled = techPoints < co.priceTp
      end
    end
  end
  nodes[48].visible = not hideCosmetics and currentDecorSale ~= nil
end

function updatePriceList(currency_, list, setRegionCoef)
  regionCoef = setRegionCoef
  currencyName = currency_
  priceList = list
  assert(propValues ~= nil)
  updateProducts()
  local nodes = interface.nodes
  local showPrice = function(obj)
    local price = getPriceStr(obj.product, obj.property)
    local n = nodes[obj.widgetsButton.priceByMoney]
    local nn = nodes[n.parent]
    local hasPrice = price ~= nil
    nn.visible = hasPrice
    if obj.widgetsButton ~= nil then
      nodes[obj.widgetsButton.button].visible = hasPrice or obj.priceTp ~= nil
    end
    nodes[obj.widgetsButton.priceByMoney].widget_text = price
    if obj.widgetsWindow ~= nil then
      nodes[obj.widgetsWindow.priceByMoney].widget_text = price
    end
  end
  for _, co in ipairs(products) do
    showPrice(co)
  end
  nodes[48].visible = not hideCosmetics and currentDecorSale ~= nil
end

function couponsUpdatePrice()
  if priceList == nil then
    return
  end
  local nodes = interface.nodes
  local amount = tonumber(nodes[5].widget_text_text)
  if amount == nil or amount < 0 then
    amount = 0
  end
  local reg = regionCoef
  nodes[8].visible = nodes[7].widget_checked
  if nodes[7].widget_checked then
    reg = 1
  end
  nodes[141].widget_text = getRegionPriceStr(priceList[couponProduct + 1], 1 * amount / reg)
end

function getRegionDiscountText(coef)
  if 1 <= coef then
    return ""
  end
  return localize("<*storeRegionalDiscount/0>" .. math.floor((1 - coef) * 100) .. "<*storeRegionalDiscount/1>")
end

function couponBuy(product)
  local nodes = interface.nodes
  closeAllWindows()
  local reg = regionCoef
  if not nodes[7].widget_checked then
    reg = 1
  end
  local name = productNames[product + 1] .. getRegionDiscountText(reg)
  local couponsCount = tonumber(nodes[5].widget_text_text)
  local json = {
    couponsCount = couponsCount,
    fullValue = not nodes[7].widget_checked,
    product = product,
    currency = root.launcher.currency.signed,
    description = name,
    language = root.language
  }
  log("Coupon buy")
  log(json)
  if root.lobby.f_sendCommand(3, toJson(json)) then
    nodes[10].disabled = true
    showError(localize("<*storeStartSteamTransaction>"))
  else
    showError(localize("<*menuErrorNoLobby>"))
  end
end

function stopMusic()
  playingDefaultMusic = false
  if music ~= nil then
    interface.sound.f_stopMusic(music, 2000)
    music = nil
  end
end

function startMusicById(id)
  stopMusic()
  music = interface.sound.f_playMusic(id, 1, 2000)
end

function startMusic()
  if playingDefaultMusic then
    return
  end
  startMusicById(math.random(0, 2))
  playingDefaultMusic = true
end

function onServerInit(data)
  connectServerTime = data.serverTime
  chestPrice = data.chestPrice
  connectLocalTime = os.time()
  local nodes = interface.nodes
  nodes[47].widget_text = chestPrice // 1000 .. " 000"
  nodes[343].widget_text = chestPrice // 1000 .. " 000"
end

local nodes = interface.nodes
for _, co in ipairs(products) do
  if co.widgetsWindow ~= nil then
    local id = co.widgetsWindow.priceByTp
    if id ~= nil then
      nodes[id].widget_text = formatNumberWithSpaces(co.priceTp)
    end
  end
  local id = co.widgetsButton.priceByTp
  if id ~= nil then
    nodes[id].widget_text = formatNumberWithSpaces(co.priceTp)
  end
  if co.highPrice ~= nil then
    local ps = formatNumberWithSpaces(co.highPrice.price)
    nodes[co.highPrice.priceWidget1].widget_text = ps
    nodes[co.highPrice.priceWidget2].widget_text = ps
  end
end
nodes[47].widget_text = chestPrice // 1000 .. " 000"
